<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>rocnet.dataset &#8212; rocnet-example  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for rocnet.dataset</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Use rocnet.Octree in a PyTorch dataset&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">exists</span><span class="p">,</span> <span class="n">getsize</span><span class="p">,</span> <span class="n">join</span><span class="p">,</span> <span class="n">splitext</span>

<span class="kn">import</span> <span class="nn">laspy</span> <span class="k">as</span> <span class="nn">lp</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">toml</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.utils</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">loadtxt</span><span class="p">,</span> <span class="n">savetxt</span>

<span class="kn">import</span> <span class="nn">rocnet.utils</span> <span class="k">as</span> <span class="nn">utils</span>
<span class="kn">from</span> <span class="nn">rocnet.octree</span> <span class="kn">import</span> <span class="n">Octree</span><span class="p">,</span> <span class="n">points_to_features</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">log_handler_stdout</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">log_handler_stdout</span><span class="p">)</span>

<span class="n">DEFAULT_METADATA</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;tileset&quot;</span><span class="p">,</span>
    <span class="s2">&quot;rel_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;recurse&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;grid_dim&quot;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
    <span class="s2">&quot;vox_size&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="s2">&quot;train_fraction&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span>
    <span class="s2">&quot;vox_attrib&quot;</span><span class="p">:</span> <span class="s2">&quot;RGB&quot;</span><span class="p">,</span>
    <span class="s2">&quot;files_in&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]],</span>
    <span class="s2">&quot;transforms&quot;</span><span class="p">:</span> <span class="p">[[],</span> <span class="p">[]],</span>
<span class="p">}</span>


<div class="viewcode-block" id="load_npy">
<a class="viewcode-back" href="../../rocnet.html#rocnet.dataset.load_npy">[docs]</a>
<span class="k">def</span> <span class="nf">load_npy</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">grid_dim</span><span class="p">):</span>
    <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span>
    <span class="k">return</span> <span class="n">pts</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="load_laz_as_voxel_indices">
<a class="viewcode-back" href="../../rocnet.html#rocnet.dataset.load_laz_as_voxel_indices">[docs]</a>
<span class="k">def</span> <span class="nf">load_laz_as_voxel_indices</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">vox_size</span><span class="p">):</span>
    <span class="n">laz</span> <span class="o">=</span> <span class="n">lp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">laz</span><span class="o">.</span><span class="n">xyz</span> <span class="o">//</span> <span class="n">vox_size</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>



<div class="viewcode-block" id="load_points">
<a class="viewcode-back" href="../../rocnet.html#rocnet.dataset.load_points">[docs]</a>
<span class="k">def</span> <span class="nf">load_points</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">grid_dim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vox_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.laz&quot;</span><span class="p">,</span> <span class="s2">&quot;.las&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">load_laz_as_voxel_indices</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">vox_size</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;.npy&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">load_npy</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">grid_dim</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File type not understood. Extension is </span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">, should be one of .las, .laz, or .npy&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="filelist">
<a class="viewcode-back" href="../../rocnet.html#rocnet.dataset.filelist">[docs]</a>
<span class="k">def</span> <span class="nf">filelist</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_samples</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">file_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">file_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">exists</span><span class="p">(</span><span class="n">file_list</span><span class="p">):</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">loadtxt</span><span class="p">(</span><span class="n">file_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_samples</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">max_samples</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Both file_list (n=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2">) and max_samples=</span><span class="si">{</span><span class="n">max_samples</span><span class="si">}</span><span class="s2"> provided, but the number of files does not match.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">files</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">midfix</span> <span class="o">=</span> <span class="s2">&quot;train&quot;</span> <span class="k">if</span> <span class="n">train</span> <span class="k">else</span> <span class="s2">&quot;test&quot;</span>
        <span class="n">all_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">midfix</span><span class="p">,</span> <span class="s2">&quot;*.npy&quot;</span><span class="p">))</span> <span class="k">if</span> <span class="n">recurse</span> <span class="k">else</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">midfix</span><span class="p">,</span> <span class="s2">&quot;*.npy&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">min_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">all_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_files</span> <span class="k">if</span> <span class="n">getsize</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_size</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">max_samples</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">all_files</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_samples</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_files</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">file_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">max_samples</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
                <span class="n">savetxt</span><span class="p">(</span><span class="n">file_list</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">files</span>
        <span class="k">return</span> <span class="n">all_files</span></div>



<div class="viewcode-block" id="write_metadata">
<a class="viewcode-back" href="../../rocnet.html#rocnet.dataset.write_metadata">[docs]</a>
<span class="k">def</span> <span class="nf">write_metadata</span><span class="p">(</span><span class="n">out_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">meta</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write metadata to the dataset dir, the only required key in meta is &#39;grid_dim&#39;&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;meta.toml&quot;</span><span class="p">)):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;meta.toml&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">toml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File already exists: </span><span class="si">{</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;meta.toml&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="Dataset">
<a class="viewcode-back" href="../../rocnet.html#rocnet.dataset.Dataset">[docs]</a>
<span class="k">class</span> <span class="nc">Dataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Access a collection of Octrees as a torch dataset&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_grid_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">file_list</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse dataset metadata without loading all the files into memory (use read_files for thta)</span>

<span class="sd">        folder: folder containing meta.toml and/or train/ and test/ subfolders</span>
<span class="sd">        model_grid_dim: model input size of the model this data is for</span>
<span class="sd">        model_leaf_dim: model leaf size of the model this data is for</span>
<span class="sd">        train: set to True for training subset, and False for testing</span>
<span class="sd">        max_samples: If this is a positive integer then this is the maximum nuber of samples which will be retrieved for this dataset</span>
<span class="sd">        file_list: If max_samples is used a random subset of famples will be used and saved to the path specified here, or if the file already exists then the list of samples in this file will be used</span>
<span class="sd">        vox_size: voxel size to use for quantisation, only required for datasets consisting of .laz files</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trees</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leaves</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_div</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">folder</span> <span class="o">=</span> <span class="n">folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train</span> <span class="o">=</span> <span class="n">train</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading dataset metadata file: </span><span class="si">{</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;meta.toml&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, train=</span><span class="si">{</span><span class="n">train</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ensure_file</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;meta.toml&quot;</span><span class="p">),</span> <span class="n">DEFAULT_METADATA</span><span class="p">)</span>  <span class="c1"># , True, True)</span>
        <span class="k">if</span> <span class="s2">&quot;grid_dim&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">grid_dim</span> <span class="o">&lt;</span> <span class="n">model_grid_dim</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset grid_dim check failed: expected dataset.grid_dim &lt;= model.grid_dim (found dataset.grid_dim=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">grid_dim</span><span class="si">}</span><span class="s2">, model.grid_dim=</span><span class="si">{</span><span class="n">model_grid_dim</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;grid_dim&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">grid_dim</span> <span class="o">&gt;</span> <span class="n">model_grid_dim</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid_div</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">grid_dim</span> <span class="o">/</span> <span class="n">model_grid_dim</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;grid_div=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_div</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_samples</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="s2">&quot;max_samples should be integer type&quot;</span>
        <span class="k">assert</span> <span class="n">max_samples</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;max_samples should be greater than zero&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_samples</span> <span class="o">=</span> <span class="n">max_samples</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;max_samples=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_samples</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;tileset&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__init_tileset</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;lazset&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__init_lazset</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset type &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&#39;not understood&quot;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__init_tileset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialise a dataset consisting of tiles divided into train/ and test subsets&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">midfix</span> <span class="o">=</span> <span class="s2">&quot;train&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span> <span class="k">else</span> <span class="s2">&quot;test&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">midfix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">filelist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_samples</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">recurse</span> <span class="k">if</span> <span class="s2">&quot;recurse&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span> <span class="n">file_list</span><span class="o">=</span><span class="n">file_list</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Init &#39;tileset&#39; dataset with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2"> files </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init_lazset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialise a dataset consisting of a set of .laz files with train/test subsets defined in meta.toml</span>

<span class="sd">        The .laz files might be located in a relative path</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">midfix</span> <span class="o">=</span> <span class="s2">&quot;train&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span> <span class="k">else</span> <span class="s2">&quot;test&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">midfix</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ensure_file</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;file_lists.toml&quot;</span><span class="p">),</span> <span class="p">{</span><span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="p">[]})[</span><span class="bp">self</span><span class="o">.</span><span class="n">midfix</span><span class="p">][:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_samples</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ensure_file</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;file_lists.toml&quot;</span><span class="p">),</span> <span class="p">{</span><span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="p">[]})[</span><span class="bp">self</span><span class="o">.</span><span class="n">midfix</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Init &#39;lazset&#39; dataset with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2"> files </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Dataset.load">
<a class="viewcode-back" href="../../rocnet.html#rocnet.dataset.Dataset.load">[docs]</a>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid_dim</span><span class="p">,</span> <span class="n">leaf_dim</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_files</span><span class="p">(</span><span class="n">grid_dim</span><span class="p">,</span> <span class="n">leaf_dim</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dataset.read_files">
<a class="viewcode-back" href="../../rocnet.html#rocnet.dataset.Dataset.read_files">[docs]</a>
    <span class="k">def</span> <span class="nf">read_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid_dim</span><span class="p">,</span> <span class="n">leaf_dim</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2"> files&quot;</span><span class="p">)</span>
        <span class="n">print_mod</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;tileset&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">%</span> <span class="n">print_mod</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">_load_resourceutilization</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">))</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="n">load_npy</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_div</span><span class="p">,</span> <span class="n">grid_dim</span><span class="p">)</span>
                <span class="n">indices</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:]</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:]</span> <span class="o">/</span> <span class="mi">256</span>
                <span class="n">features</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">points_to_features</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">grid_dim</span><span class="p">,</span> <span class="n">leaf_dim</span><span class="p">,</span> <span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">tree</span> <span class="o">=</span> <span class="n">Octree</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="n">labels</span><span class="o">.</span><span class="n">int</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">%</span> <span class="n">print_mod</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">_load_resourceutilization</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">))</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="n">load_laz_as_voxel_indices</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">vox_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">vox_size</span><span class="p">)</span>
                <span class="n">features</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">points_to_features</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">grid_dim</span><span class="p">,</span> <span class="n">leaf_dim</span><span class="p">)</span>
                <span class="n">tree</span> <span class="o">=</span> <span class="n">Octree</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="n">labels</span><span class="o">.</span><span class="n">int</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">)</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">rocnet-example</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../examine_dataset.html">examine_dataset module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examine_training_run.html">examine_training_run module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../test_file.html">test_file module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../test_tile.html">test_tile module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tile.html">tile module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../train.html">train module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utils.html">utils module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rocnet.html">rocnet package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Author.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>